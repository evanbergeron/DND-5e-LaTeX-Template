% DND 5e LaTeX Style File
% Created by Evan Bergeron
% Modified by Christopher Liu December 2015
% Modified by Yannic Meyer Feb 2016

\ProvidesPackage{dnd}[2016/03/13]

%
% Prerequisite Packages
%

\RequirePackage{lipsum}           % Filler text
\RequirePackage[cm]{fullpage}     % Small margins
\RequirePackage{bookman}          % Closest built-in font I could find
\RequirePackage[T1]{fontenc}
\RequirePackage[table]{xcolor}
\RequirePackage{array}
\RequirePackage{tabularx}
\RequirePackage{tikz}
\RequirePackage{keycommand}
\RequirePackage{fancyhdr} 			  % Adaptation of the footers
\RequirePackage[most]{tcolorbox}  % used for some boxes
\RequirePackage{enumitem}
\RequirePackage{ragged2e}

% Get this file absolute path, from
% https://tex.stackexchange.com/questions/42417/full-path-of-current-file
\makeatletter
\def\thepwd@default{./}
\let\thepwd\thepwd@default
\let\theabspath\@empty
\newcommand\getabspath{%
    \begingroup
    \edef\filename{dnd.sty}%
    \@onelevel@sanitize\filename%
    \let\thepwd\thepwd@default
    \let\theabspath\@empty
    \IfFileExists{\jobname.fls}{%
        \openin\@inputcheck=\jobname.fls\relax
        \endlinechar\m@ne
        \readline\@inputcheck to \line
        \expandafter\getabspath@extr\line\relax\relax\relax\relax\relax
        \expandafter\getabspath@defs\expandafter{\filename}%
        \loop
            \readline\@inputcheck to \line
            \@onelevel@sanitize\line
            \expandafter\getabspath@path\expandafter{\line}%
            \ifeof\@inputcheck
                \let\iterate\relax
            \fi
            \ifx\theabspath\@empty
        \repeat
        \closein\@inputcheck
    }{%
        \PackageWarning{getabspath}
            {The required recorder file (.fls) was not found.\MessageBreak
             Please compile with the '-recorder' option.\MessageBreak
             Occurred}%
    }%
    \ifx\theabspath\@empty
        \let\theabspath\thepwd
    \fi
    \edef\@tempa{%
        \def\noexpand\thepwd{\thepwd}%
        \def\noexpand\theabspath{\theabspath}%
    }%
    \expandafter
    \endgroup
    \@tempa
}
\def\getabspath@extr#1#2#3#4#5\relax{%
    \edef\@tempa{\detokenize{#1#2#3}}%
    \edef\@tempb{\detokenize{PWD}}%
    \ifx\@tempa\@tempb
       \edef\thepwd{\detokenize{#4#5/}}%
    \fi
}

\begingroup
\catcode`I=12
\catcode`N=12
\catcode`P=12
\catcode`U=12
\catcode`T=12
\gdef\getabspath@defs#1{%
    \def\getabspath@@path ##1INPUT ##2#1\relax##3\relax##4\@nnil{%
        \ifx\@empty##4\@empty\else
            \def\theabspath{##2}%
        \fi
    }%
    \def\getabspath@path##1{%
        \getabspath@@path##1\relax INPUT \@empty#1\relax{}\relax\@nnil
    }%
}
\endgroup
\makeatother

\getabspath

% Load other modules of this package
\usepackage{\theabspath lib/dndmonster}
\usepackage{\theabspath lib/dndsections}
\usepackage{\theabspath lib/dndcomment}
\usepackage{\theabspath lib/dnditemtable}
\usepackage{\theabspath lib/dndtable}
\usepackage{\theabspath lib/dndquote}
\usepackage{\theabspath lib/dndpaperbox}
\usepackage{\theabspath lib/dndspell}

%
% Options
%

% 'bg-letter-img','bg-letter-print' and 'bg-none' options
\newtoggle{bool-bg-a4}
\newtoggle{bool-bg-print}
\newtoggle{bool-bg-none}
\DeclareOption{bg-none}{\toggletrue{bool-bg-none}}
\DeclareOption{bg-a4}{\toggletrue{bool-bg-a4}}
\DeclareOption{bg-letter}{\togglefalse{bool-bg-a4}}
\DeclareOption{bg-print}{\toggletrue{bool-bg-print}}
\DeclareOption{bg-full}{\togglefalse{bool-bg-print}}

% Toggle justification (official books are flush left).
\newtoggle{justified}
\DeclareOption{justified}{\toggletrue{justified}}

% Default Settings
\ExecuteOptions{bg-letter, bg-full}
\ProcessOptions\relax

\nottoggle{bool-bg-none}{
  % Determine background image
  \iftoggle{bool-bg-a4}{%		% Check if A4 option is selected
    \iftoggle{bool-bg-print}{%	% Check if print option is selected
      \RequirePackage[a4,print]{\theabspath lib/dndbackgroundimg}
		}{%
      \RequirePackage[a4,full]{\theabspath lib/dndbackgroundimg}
		}
	}{%
    \iftoggle{bool-bg-print}{%	% Check if print option is selected
      \RequirePackage[letter,print]{\theabspath lib/dndbackgroundimg}
		}{%
      \RequirePackage[letter,full]{\theabspath lib/dndbackgroundimg}
		}
	}
}

\nottoggle{justified}{
  \setlength{\RaggedRightParindent}{1em}
  \RaggedRight
}

%
% Style Parameters
%

% Disable space between paragraphs.
\setlength{\parskip}{0pt}

% Font environment
\newenvironment{lmss}{\fontfamily{lmss}\selectfont}{}

% Columns setup
\setlength{\columnsep}{1cm}

% Define colors, sampled from the books.
\usepackage{color}
\definecolor{bgtan}{HTML}{F7F2E5}		% e.g. used for background and quotebox
\definecolor{titlered}{HTML}{58180D}	% e.g. used for titles
\definecolor{undergold}{HTML}{C9AD6A}	% e.g. used for titlerules
\definecolor{uppergold}{HTML}{B89A67}	%e.g. used for pagenumbers and footer
\definecolor{puregold}{HTML}{E69A28}	%e.g. used for top line in newer monsterbox
\definecolor{monstertan}{HTML}{FDF1DC}	%e.g. used for newer monsterblock
\definecolor{monstertandark}{HTML}{F0DBB5}	%e.g. used for older monsterbox
\definecolor{commentgreen}{HTML}{E0E5C1} % e.g. used in table and green commentbox
\definecolor{itemtablepink}{HTML}{E9CDC2} % e.g. used in item tables instead of the green
\definecolor{rulered}{HTML}{9C2B1B}		%e.g. used for triangular rule in statsblock

% Customize itemize environment.
\setlist{leftmargin=1em}
\setitemize{noitemsep,topsep=0.5ex}
\renewcommand{\labelitemi}{\raisebox{0.25ex}{\tiny{$\bullet$}}}

% Setup for custom footer
\pagestyle{fancy}

\footskip = 48pt %push the footer down so it fits with the decal from the bg-img
\fancyhfoffset[LE]{28pt} % push the footer left on even pages so it fits the decal
\fancyhfoffset[RO]{30pt} % push the footer right on odd pages so it fits the decalbg-img
\renewcommand{\headrulewidth}{0.0pt} %no rule for header
\renewcommand{\footrulewidth}{0.0pt} %no rule for footer

\fancyhead{} % clear all header fields
\fancyfoot{} % clear all footer fields

\fancyfoot[LE]{
	\textcolor{uppergold}{\thepage}
	\hspace*{0.9cm}
	\raisebox{12pt}{\textsc{\textcolor{uppergold}{\nouppercase\leftmark}}}
	}

\fancyfoot[RO]{
	\raisebox{12pt}{\textsc{\textcolor{uppergold}{\nouppercase\leftmark}}}
	\hspace*{1cm}
	\textcolor{uppergold}{\thepage}
	}

\renewcommand{\chaptermark}[1]{\markboth{#1}{}} % Don not write word "chapter"

\fancypagestyle{plain}{}

% Fancy DnD 5e-style hline
\renewcommand{\hline}{
\noindent
  \begin{tikzpicture}[]
    \draw [rulered, fill=rulered] (0, 0) --(0,0.1) -- (\textwidth, 0.08);
  \end{tikzpicture}
}


% Either hilariously, or infuriatingly, the \ifcommandkey
% implementation is buggy. Here is a re-implementation
% from tex.stackexchange.
\begingroup
  \makeatletter
  \catcode`\/=8 %
  \@firstofone
    {
      \endgroup
      \renewcommand{\ifcommandkey}[1]{%
        \csname @\expandafter \expandafter \expandafter
        \expandafter \expandafter \expandafter  \expandafter
        \kcmd@nbk \commandkey {#1}//{first}{second}//oftwo\endcsname
      }
   }
